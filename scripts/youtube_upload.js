// Script de Upload para YouTube - Apocalypse Academy
// Uso: node youtube_upload.js <video_file> <curso_id> <aula_id> <distribution_type>

const fs = require('fs');
const path = require('path');
const { google } = require('googleapis');

// Configura√ß√µes do YouTube API
const YOUTUBE_CONFIG = {
  clientId: process.env.YOUTUBE_CLIENT_ID,
  clientSecret: process.env.YOUTUBE_CLIENT_SECRET,
  refreshToken: process.env.YOUTUBE_REFRESH_TOKEN,
  redirectUri: 'urn:ietf:wg:oauth:2.0:oob'
};

// Configura√ß√µes de upload
const UPLOAD_CONFIG = {
  part: 'snippet,status',
  requestBody: {
    snippet: {
      categoryId: '27', // Education
      defaultLanguage: 'pt-BR',
      defaultAudioLanguage: 'pt-BR'
    },
    status: {
      privacyStatus: 'private', // Ser√° atualizado baseado no distribution_type
      selfDeclaredMadeForKids: false
    }
  },
  media: {
    body: null // Ser√° definido com o arquivo de v√≠deo
  }
};

class YouTubeUploader {
  constructor() {
    this.oauth2Client = null;
    this.youtube = null;
    this.initializeAuth();
  }

  // Inicializar autentica√ß√£o
  initializeAuth() {
    this.oauth2Client = new google.auth.OAuth2(
      YOUTUBE_CONFIG.clientId,
      YOUTUBE_CONFIG.clientSecret,
      YOUTUBE_CONFIG.redirectUri
    );

    this.oauth2Client.setCredentials({
      refresh_token: YOUTUBE_CONFIG.refreshToken
    });

    this.youtube = google.youtube({
      version: 'v3',
      auth: this.oauth2Client
    });
  }

  // Validar par√¢metros
  validateParams(args) {
    if (args.length < 4) {
      throw new Error('Uso: node youtube_upload.js <video_file> <curso_id> <aula_id> <distribution_type>');
    }

    const [videoFile, cursoId, aulaId, distributionType] = args;

    if (!fs.existsSync(videoFile)) {
      throw new Error(`Arquivo de v√≠deo n√£o encontrado: ${videoFile}`);
    }

    if (!['youtube_public', 'youtube_unlisted'].includes(distributionType)) {
      throw new Error(`Tipo de distribui√ß√£o inv√°lido: ${distributionType}`);
    }

    return { videoFile, cursoId, aulaId, distributionType };
  }

  // Carregar metadados do curso
  async loadCourseMetadata(cursoId, aulaId) {
    try {
      const catalogPath = path.join(__dirname, '../api/catalog.json');
      const catalog = JSON.parse(fs.readFileSync(catalogPath, 'utf8'));
      
      const course = catalog.courses.find(c => c.id === cursoId);
      if (!course) {
        throw new Error(`Curso n√£o encontrado: ${cursoId}`);
      }

      let lesson = null;
      for (const module of course.modules) {
        const foundLesson = module.lessons.find(l => l.id === aulaId);
        if (foundLesson) {
          lesson = foundLesson;
          break;
        }
      }

      if (!lesson) {
        throw new Error(`Aula n√£o encontrada: ${aulaId}`);
      }

      return { course, lesson };
    } catch (error) {
      console.error('Erro ao carregar metadados:', error.message);
      throw error;
    }
  }

  // Gerar t√≠tulo e descri√ß√£o para YouTube
  generateVideoMetadata(course, lesson, distributionType) {
    const isTrailer = distributionType === 'youtube_public';
    
    let title, description;

    if (isTrailer) {
      title = `${lesson.title} - TRAILER | ${course.title} | Apocalypse Academy`;
      description = this.generateTrailerDescription(course, lesson);
    } else {
      title = `${lesson.title} | ${course.title} | Apocalypse Academy`;
      description = this.generateLessonDescription(course, lesson);
    }

    return { title, description };
  }

  // Gerar descri√ß√£o para trailer
  generateTrailerDescription(course, lesson) {
    return `üé¨ TRAILER OFICIAL

${lesson.description}

üìö CURSO COMPLETO: ${course.title}
üë®‚Äçüè´ INSTRUTOR: ${course.instructor}
‚è±Ô∏è DURA√á√ÉO: ${this.formatDuration(lesson.durationSec)}
üéØ N√çVEL: ${course.level}

üî• ACESSE O CURSO COMPLETO:
üëâ https://apocalypseacademy.com/cursos/${course.slug}

üìñ SOBRE O CURSO:
${course.description}

üéì O QUE VOC√ä VAI APRENDER:
${course.modules.map((module, index) => `${index + 1}. ${module.title}`).join('\n')}

üåü APOCALYPSE ACADEMY
A plataforma definitiva para compreender os sinais dos tempos e se preparar para os √∫ltimos dias.

üì± SIGA-NOS:
‚Ä¢ Instagram: @apocalypseacademy
‚Ä¢ Telegram: t.me/apocalypseacademy
‚Ä¢ Spotify: Devocionais Prof√©ticos

üè∑Ô∏è TAGS:
#ApocalypseAcademy #Escatologia #Profecia #UltimosTempos #SinaisDosTempo #EstudoBiblico #Preparacao #${course.category}

‚ö†Ô∏è AVISO LEGAL:
Este conte√∫do √© baseado em interpreta√ß√µes b√≠blicas e tem fins educacionais. Sempre consulte as Escrituras e busque orienta√ß√£o espiritual.`;
  }

  // Gerar descri√ß√£o para aula completa
  generateLessonDescription(course, lesson) {
    return `üìö AULA COMPLETA

${lesson.description}

üéì CURSO: ${course.title}
üë®‚Äçüè´ INSTRUTOR: ${course.instructor}
‚è±Ô∏è DURA√á√ÉO: ${this.formatDuration(lesson.durationSec)}
üéØ N√çVEL: ${course.level}

üìñ SOBRE ESTA AULA:
Nesta aula do curso "${course.title}", exploramos em profundidade os conceitos apresentados no t√≠tulo "${lesson.title}".

üîó ACESSE A PLATAFORMA:
üëâ https://apocalypseacademy.com

üìã CAP√çTULOS:
00:00 Introdu√ß√£o
${this.generateChapterTimestamps(lesson.durationSec)}

üìö RECURSOS ADICIONAIS:
‚Ä¢ Apostila em PDF
‚Ä¢ √Åudios para download
‚Ä¢ Exerc√≠cios pr√°ticos
‚Ä¢ Certificado de conclus√£o

üåü APOCALYPSE ACADEMY
A plataforma definitiva para compreender os sinais dos tempos e se preparar para os √∫ltimos dias.

üì± CONECTE-SE CONOSCO:
‚Ä¢ Site: https://apocalypseacademy.com
‚Ä¢ Instagram: @apocalypseacademy
‚Ä¢ Telegram: t.me/apocalypseacademy
‚Ä¢ Spotify: Devocionais Prof√©ticos

üè∑Ô∏è TAGS:
#ApocalypseAcademy #Escatologia #Profecia #UltimosTempos #SinaisDosTempo #EstudoBiblico #Preparacao #${course.category} #AulaCompleta

‚ö†Ô∏è DIREITOS AUTORAIS:
¬© 2024 Apocalypse Academy. Todos os direitos reservados. Este conte√∫do √© protegido por direitos autorais e destinado exclusivamente aos alunos matriculados.`;
  }

  // Gerar timestamps de cap√≠tulos
  generateChapterTimestamps(durationSec) {
    const chapterDuration = 300; // 5 minutos
    const totalChapters = Math.floor(durationSec / chapterDuration);
    const timestamps = [];

    for (let i = 1; i <= totalChapters; i++) {
      const time = i * chapterDuration;
      const formatted = this.formatTimestamp(time);
      timestamps.push(`${formatted} Cap√≠tulo ${i}`);
    }

    return timestamps.join('\n');
  }

  // Formatar dura√ß√£o em minutos
  formatDuration(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    
    if (hours > 0) {
      return `${hours}h ${minutes}min`;
    }
    return `${minutes}min`;
  }

  // Formatar timestamp para cap√≠tulos
  formatTimestamp(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;

    if (hours > 0) {
      return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    return `${minutes}:${secs.toString().padStart(2, '0')}`;
  }

  // Gerar tags para o v√≠deo
  generateTags(course, lesson) {
    const baseTags = [
      'Apocalypse Academy',
      'Escatologia',
      'Profecia',
      '√öltimos Tempos',
      'Sinais dos Tempos',
      'Estudo B√≠blico',
      'Prepara√ß√£o',
      'Eric Alberto da Cruz'
    ];

    const courseTags = [
      course.category,
      course.title,
      course.level
    ];

    const lessonTags = lesson.title.split(' ').filter(word => word.length > 3);

    return [...baseTags, ...courseTags, ...lessonTags].slice(0, 15); // YouTube limita a 15 tags
  }

  // Fazer upload do v√≠deo
  async uploadVideo(videoFile, metadata, distributionType) {
    console.log('Iniciando upload para YouTube...');
    
    const { title, description } = metadata;
    const tags = this.generateTags(metadata.course, metadata.lesson);
    
    // Configurar privacidade baseada no tipo de distribui√ß√£o
    const privacyStatus = distributionType === 'youtube_public' ? 'public' : 'unlisted';
    
    const uploadConfig = {
      ...UPLOAD_CONFIG,
      requestBody: {
        ...UPLOAD_CONFIG.requestBody,
        snippet: {
          ...UPLOAD_CONFIG.requestBody.snippet,
          title: title,
          description: description,
          tags: tags
        },
        status: {
          ...UPLOAD_CONFIG.requestBody.status,
          privacyStatus: privacyStatus
        }
      },
      media: {
        body: fs.createReadStream(videoFile)
      }
    };

    try {
      console.log(`Fazendo upload: ${title}`);
      console.log(`Privacidade: ${privacyStatus}`);
      
      const response = await this.youtube.videos.insert(uploadConfig);
      
      const videoId = response.data.id;
      const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
      
      console.log('‚úÖ Upload conclu√≠do com sucesso!');
      console.log(`üì∫ Video ID: ${videoId}`);
      console.log(`üîó URL: ${videoUrl}`);
      
      return {
        videoId,
        videoUrl,
        embedUrl: `https://www.youtube.com/embed/${videoId}`,
        status: 'uploaded',
        privacyStatus
      };
      
    } catch (error) {
      console.error('‚ùå Erro no upload:', error.message);
      throw error;
    }
  }

  // Atualizar cat√°logo com informa√ß√µes do YouTube
  async updateCatalogWithYouTube(cursoId, aulaId, youtubeData) {
    try {
      const catalogPath = path.join(__dirname, '../api/catalog.json');
      const catalog = JSON.parse(fs.readFileSync(catalogPath, 'utf8'));
      
      // Encontrar e atualizar a aula
      for (const course of catalog.courses) {
        if (course.id === cursoId) {
          for (const module of course.modules) {
            const lesson = module.lessons.find(l => l.id === aulaId);
            if (lesson) {
              // Atualizar informa√ß√µes do YouTube
              if (!lesson.youtube) {
                lesson.youtube = {};
              }
              
              lesson.youtube = {
                videoId: youtubeData.videoId,
                embedUrl: youtubeData.embedUrl,
                watchUrl: youtubeData.videoUrl,
                privacyStatus: youtubeData.privacyStatus,
                uploadedAt: new Date().toISOString()
              };
              
              lesson.updatedAt = new Date().toISOString();
              break;
            }
          }
          break;
        }
      }
      
      // Atualizar timestamp do cat√°logo
      catalog.metadata.lastUpdated = new Date().toISOString();
      
      // Salvar cat√°logo atualizado
      fs.writeFileSync(catalogPath, JSON.stringify(catalog, null, 2));
      
      console.log('‚úÖ Cat√°logo atualizado com informa√ß√µes do YouTube');
      
    } catch (error) {
      console.error('‚ùå Erro ao atualizar cat√°logo:', error.message);
      throw error;
    }
  }

  // Fun√ß√£o principal
  async run(args) {
    try {
      console.log('üé¨ APOCALYPSE ACADEMY - UPLOAD YOUTUBE');
      console.log('=====================================');
      
      // Validar par√¢metros
      const { videoFile, cursoId, aulaId, distributionType } = this.validateParams(args);
      
      console.log(`üìÅ Arquivo: ${videoFile}`);
      console.log(`üìö Curso: ${cursoId}`);
      console.log(`üéì Aula: ${aulaId}`);
      console.log(`üì° Distribui√ß√£o: ${distributionType}`);
      console.log('');
      
      // Carregar metadados
      console.log('üìñ Carregando metadados do curso...');
      const { course, lesson } = await this.loadCourseMetadata(cursoId, aulaId);
      
      // Gerar metadados do v√≠deo
      console.log('‚úèÔ∏è Gerando metadados do v√≠deo...');
      const videoMetadata = this.generateVideoMetadata(course, lesson, distributionType);
      videoMetadata.course = course;
      videoMetadata.lesson = lesson;
      
      console.log(`üìù T√≠tulo: ${videoMetadata.title}`);
      console.log('');
      
      // Fazer upload
      const youtubeData = await this.uploadVideo(videoFile, videoMetadata, distributionType);
      
      // Atualizar cat√°logo
      console.log('üìã Atualizando cat√°logo...');
      await this.updateCatalogWithYouTube(cursoId, aulaId, youtubeData);
      
      console.log('');
      console.log('üéâ UPLOAD CONCLU√çDO COM SUCESSO!');
      console.log(`üîó Acesse: ${youtubeData.videoUrl}`);
      
      return youtubeData;
      
    } catch (error) {
      console.error('üí• ERRO NO UPLOAD:', error.message);
      process.exit(1);
    }
  }
}

// Executar se chamado diretamente
if (require.main === module) {
  const uploader = new YouTubeUploader();
  uploader.run(process.argv.slice(2));
}

module.exports = YouTubeUploader;

